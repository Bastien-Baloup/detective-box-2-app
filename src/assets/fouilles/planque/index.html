<!DOCTYPE html>
<html>

<head>
	<title>Planque</title>
	<meta charset="utf-8">
	<meta name="viewport"
		content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui" />
	<style>
		@-ms-viewport {
			width: device-width;
		}
	</style>
	<link rel="stylesheet" href="vendor/reset.min.css">
	<link rel="stylesheet" href="style.css">
</head>

<body class="multiple-scenes ">

	<div id="pano"></div>

	<div id="sceneList">
		<ul class="scenes">

			<a href="javascript:void(0)" class="scene" data-id="0-103_planque_grnier_1">
				<li class="text">103_planque_grnier_1</li>
			</a>

			<a href="javascript:void(0)" class="scene" data-id="1-103_planque_grnier_2">
				<li class="text">103_planque_grnier_2</li>
			</a>

		</ul>
	</div>

	<div id="titleBar">
		<h1 class="sceneName"></h1>
	</div>

	<a href="javascript:void(0)" id="autorotateToggle">
		<img class="icon off" src="img/play.png">
		<img class="icon on" src="img/pause.png">
	</a>

	<a href="javascript:void(0)" id="fullscreenToggle">
		<img class="icon off" src="img/fullscreen.png">
		<img class="icon on" src="img/windowed.png">
	</a>

	<a href="javascript:void(0)" id="sceneListToggle">
		<img class="icon off" src="img/expand.png">
		<img class="icon on" src="img/collapse.png">
	</a>

	<a href="javascript:void(0)" id="viewUp" class="viewControlButton viewControlButton-1">
		<img class="icon" src="img/up.png">
	</a>
	<a href="javascript:void(0)" id="viewDown" class="viewControlButton viewControlButton-2">
		<img class="icon" src="img/down.png">
	</a>
	<a href="javascript:void(0)" id="viewLeft" class="viewControlButton viewControlButton-3">
		<img class="icon" src="img/left.png">
	</a>
	<a href="javascript:void(0)" id="viewRight" class="viewControlButton viewControlButton-4">
		<img class="icon" src="img/right.png">
	</a>
	<a href="javascript:void(0)" id="viewIn" class="viewControlButton viewControlButton-5">
		<img class="icon" src="img/plus.png">
	</a>
	<a href="javascript:void(0)" id="viewOut" class="viewControlButton viewControlButton-6">
		<img class="icon" src="img/minus.png">
	</a>


	<div class="img" id="img-see1" style="display:none">
		<span class="close-img">X</span>
		<img src="assets/carte-5.jpg" class="img-see">
	</div>
	<div class="img" id="img-see2" style="display:none">
		<span class="close-img">X</span>
		<img src="assets/carte-3.jpg" class="img-see">
	</div>
	<div class="img" id="img-see3" style="display:none">
		<span class="close-img">X</span>
		<img src="assets/carte-4.jpg" class="img-see">
	</div>

	<div class="img" id="img-see4" style="display:none">
		<span class="close-img">X</span>
		<img src="assets/carte-1.jpg" class="img-see">
	</div>
	<div class="img" id="img-see5" style="display:none">
		<span class="close-img">X</span>
		<img src="assets/carte-2.jpg" class="img-see">
	</div>
	<div class="img" id="img-see6" style="display:none">
		<span class="close-img">X</span>
		<img src="assets/mot.jpg" class="img-see">
	</div>

	<a href="#" id="back-button" class="btn-red"
		style="display:none; font-size:1.4em; position:absolute; right:10px; bottom:10px" onclick="clicHandle()">Aller
		interroger Garraud</a>

	<audio id="song" loop controls style="display:none">
		<source src="assets/music.mp3" type="audio/mpeg">
		Your browser does not support the audio element.
	</audio>
	<audio id="comment" controls style="display:none">
		<source src="assets/comment.mp3" type="audio/mpeg">
		Your browser does not support the audio element.
	</audio>
	<audio id="arrival" controls style="display:none">
		<source src="assets/arrival.mp3" type="audio/mpeg">
		Your browser does not support the audio element.
	</audio>

	<script src="vendor/screenfull.min.js"></script>
	<script src="vendor/bowser.min.js"></script>
	<script src="vendor/marzipano.js"></script>

	<script>
		const clicHandle = async () => {
			const token = localStorage.getItem('token')
			if (!token) {
				alert("Erreur de communication avec l'app détectivebox : Token vide")
				return
			}
			const response = await fetch('https://api2.detectivebox.fr/history/1?id=box1document6', {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${localStorage.getItem('token')}`,
				},
				body: JSON.stringify({ status: true })
			})
			console.table(response)
			if (!response.ok) {
				alert('Erreur de comunication avec le serveur: ' + response.status + (response.statusText !== '' ? ' - ' + response.statusText : ''))
			} else {
				alert('Rendez-vous sur l\'application pour la suite de l\'enquête')
			}
		}

		document.addEventListener('DOMContentLoaded', () => {
			const params = new URLSearchParams(window.location.search)
			localStorage.setItem('token', params.get('token'))
			const arrivalPlanque1 = sessionStorage.getItem('arrival_planque_1')

			document.querySelectorAll('.close-img').forEach((element) => {
				element.addEventListener('click', () => {
					document.querySelectorAll('.img').forEach((imgElement) => {
						imgElement.style.display = 'none'
					})
				})
			})

			document.querySelectorAll('.watch').forEach((element) => {
				element.addEventListener('click', () => {
					document.querySelectorAll('.img').forEach((imgElement) => {
						imgElement.style.display = 'none'
					})
					const id = element.getAttribute('id')
					document.getElementById('img-' + id).style.display = 'block'

					if (id == 'see6') {
						document.getElementById('arrival').volume = 0

						if (document.getElementById('comment').getAttribute('src') !== '') {
							document.getElementById('comment').play()
						}

						document.getElementById('comment').addEventListener('ended', () => {
							document.getElementById('comment').setAttribute('src', '')
							clicHandle()
						})
					}
				})
			})

			if (!arrivalPlanque1) {
				const bodyClickHandler = (event) => {
					setTimeout(() => {
						document.getElementById('arrival').play()
						document.body.removeEventListener('click', bodyClickHandler)
					}, 3000)
				}
				document.body.addEventListener('click', bodyClickHandler)
			}

			const bodyClickHandler = (event) => {
				document.getElementById('song').play()
				document.getElementById('song').volume = 0.2
			}
			document.body.addEventListener('click', bodyClickHandler)

			sessionStorage.setItem('arrival_planque_1', '1')
		});		
	</script>
	<script src="data.js"></script>
	<script src="index.js"></script>

</body>

</html>